#!/bin/bash
if [ "$1" == "-h" ]||[ "$1" == "--help" ]||[ "$1" == "help" ] ; then echo '
########################################################################
# Script to gen armhf debian based linux image for xe303c12            #
# Dev. https://git[hu,la]b.com/quarkscript                 License GPL #
# Place kernel source file, united patch, config and execute           #
# sudo '$0' [ck,bts,bdi] [kali] ["size"] ["patch"] [btrfs,f2fs]   #
# ck - compile kernel stage                                            #
# bts - build target system stage                                      #
# bdi - build disk image stage, depends of all previous stages         #
# [kali,devuan,devuan-lxqt] - supported distributions                  #
# size - disk image size, 2-128 (G) or 1882-131092 (M); 7G by default  #
# patch - united kernel patch                                          #
# btrfs,f2fs - root part filesystem type, otherwise ext4 will be used  #
# Sequence is not important. All params are optional.                  #
# This script could work on debian based i686 or x86_64 sytems         #
# It is better to not mix distro types i.e. gen Kali at x86 Kali..     #
# Deps will be installed automatically, root privileges are required.  #
########################################################################
'
    exit 0
fi

## def vars
fstype=ext4
disksize=$((7*1024))
patch=''
stages=''
hostpackages='git-core gnupg flex bison gperf build-essential zip curl libncurses5-dev zlib1g-dev gcc g++ parted kpartx debootstrap pixz qemu-user-static abootimg cgpt vboot-kernel-utils vboot-utils u-boot-tools bc lzma lzop automake autoconf m4 dosfstools rsync schedtool git dosfstools e2fsprogs device-tree-compiler libssl-dev qemu-user-static btrfs-progs f2fs-tools binutils binutils-arm-linux-gnueabihf gcc-arm-linux-gnueabihf'
hostpackages_32bit='libstdc++6:i386 libgcc1:i386 zlib1g:i386 libncurses5:i386'
target_hostname=kali
basedir="$(pwd)/$target_hostname-exynos"
mirror=http.kali.org
architecture="armhf"
debootstrap_string="debootstrap --foreign --arch $architecture kali-rolling $target_hostname-$architecture http://$mirror/$target_hostname"
sources_list="deb http://$mirror/$target_hostname kali-rolling main contrib non-free"
targetpackages_2="git-core ca-certificates initramfs-tools"
targetpackages_3="locales console-common less nano git"
targetpackages='acl adduser adwaita-icon-theme alsa-topology-conf alsa-ucm-conf alsa-utils alsamixergui appmenu-gtk-module-common appmenu-gtk2-module appmenu-gtk3-module appmenu-registrar apt-transport-https apt-utils apt aptitude-common aptitude aspell-en aspell at-spi2-core atril-common atril avahi-daemon ayatana-indicator-application ayatana-indicator-common bamfdaemon base-files base-passwd bash-completion bash bind9-host bind9-libs bluez-obexd bluez bsdextrautils bsdutils btrfs-progs bubblewrap busybox bzip2 ca-certificates cgpt colord-data colord conky-std conky console-common console-data console-setup-linux console-setup coreutils cpio cpp-10 cpp crda cron curl dash dbus-user-session dbus-x11 dbus dconf-gsettings-backend dconf-service debconf-i18n debconf debian-archive-keyring debianutils debtags desktop-base desktop-file-utils device-tree-compiler dialog dictionaries-common diffutils dirmngr distro-info-data dmidecode dmsetup dns-root-data dnsmasq-base dosfstools dpkg e2fsprogs eject emacsen-common enchant-2 exfat-fuse exfat-utils exo-utils f2fs-tools fdisk file findutils firefox-esr fontconfig-config fontconfig fonts-dejavu-core fonts-droid-fallback fonts-liberation fonts-mathjax fonts-noto-mono fonts-quicksand fonts-terminus-otb fonts-urw-base35 fuse3 gcc-10-base gcc-9-base gcr gdisk gir1.2-atk-1.0 gir1.2-freedesktop gir1.2-gdkpixbuf-2.0 gir1.2-glib-2.0 gir1.2-gtk-3.0 gir1.2-harfbuzz-0.0 gir1.2-pango-1.0 git-man git glib-networking-common glib-networking-services glib-networking gnome-accessibility-themes gnome-desktop3-data gnome-icon-theme gnome-keyring-pkcs11 gnome-keyring gnome-themes-extra-data gnome-themes-extra gnupg-l10n gnupg-utils gnupg gparted-common gparted gpg-agent gpg-wks-client gpg-wks-server gpg gpgconf gpgsm gpgv grep groff-base gsettings-desktop-schemas gstreamer1.0-alsa gstreamer1.0-gl gstreamer1.0-libav gstreamer1.0-plugins-bad gstreamer1.0-plugins-base gstreamer1.0-plugins-good gstreamer1.0-x gtk-update-icon-cache gtk2-engines-pixbuf gvfs-backends gvfs-common gvfs-daemons gvfs-libs gvfs gzip hddtemp hicolor-icon-theme hostname hunspell-en-us ifupdown init-system-helpers init initramfs-tools-core initramfs-tools ipp-usb iproute2 iptables iputils-ping isc-dhcp-client isc-dhcp-common iso-codes iw kali-archive-keyring kali-desktop-base kali-root-login kali-themes-common kali-wallpapers-2020.4 kali-wallpapers-2021.4 kbd keyboard-configuration klibc-utils kmod less libaa1 libaacs0 libacl1 libaom0 libapparmor1 libappmenu-gtk2-parser0 libappmenu-gtk3-parser0 libapt-pkg6.0 libarchive13 libargon2-1 libasound2-data libasound2-plugins libasound2 libaspell15 libass9 libassuan0 libasyncns0 libatasmart4 libatk-bridge2.0-0 libatk1.0-0 libatk1.0-data libatkmm-1.6-1v5 libatopology2 libatrildocument3 libatrilview3 libatspi2.0-0 libattr1 libaudit-common libaudit1 libauthen-sasl-perl libavahi-client3 libavahi-common-data libavahi-common3 libavahi-core7 libavahi-glib1 libavc1394-0 libavcodec58 libavfilter7 libavformat58 libavresample4 libavutil56 libayatana-appindicator3-1 libayatana-ido3-0.4-0 libayatana-indicator3-7 libbamf3-2 libbdplus0 libblas3 libblkid1 libblockdev-crypto2 libblockdev-fs2 libblockdev-loop2 libblockdev-part-err2 libblockdev-part2 libblockdev-swap2 libblockdev-utils2 libblockdev2 libbluetooth3 libbluray2 libboost-iostreams1.74.0 libbpf0 libbrotli1 libbs2b0 libbsd0 libburn4 libbz2-1.0 libc-bin libc-l10n libc6 libcaca0 libcairo-gobject2 libcairo2 libcairomm-1.0-1v5 libcaja-extension1 libcanberra-gtk-module libcanberra-gtk0 libcanberra-gtk3-0 libcanberra-gtk3-module libcanberra0 libcap-ng0 libcap2-bin libcap2 libcbor0 libccid libcdio-cdda2 libcdio-paranoia2 libcdio19 libcdparanoia0 libchromaprint1 libclone-perl libcodec2-0.9 libcolord2 libcolorhug2 libcom-err2 libcpupower1 libcrypt1 libcryptsetup12 libcups2 libcurl3-gnutls libcurl4 libcwidget4 libdaemon0 libdata-dump-perl libdatrie1 libdav1d4 libdb5.3 libdbus-1-3 libdbus-glib-1-2 libdbusmenu-glib4 libdbusmenu-gtk3-4 libdbusmenu-gtk4 libdc1394-25 libdca0 libdconf1 libde265-0 libdebconfclient0 libdeflate0 libdevmapper1.02.1 libdjvulibre-text libdjvulibre21 libdns-export1110 libdpkg-perl libdrm-amdgpu1 libdrm-common libdrm-nouveau2 libdrm-radeon1 libdrm2 libdv4 libdvdnav4 libdvdread8 libdw1 libedit2 libegl-mesa0 libegl1 libelf1 libenchant-2-2 libencode-locale-perl libepoxy0 liberror-perl libestr0 libevdev2 libevent-2.1-7 libexif12 libexo-2-0 libexo-common libexpat1 libext2fs2 libfaad2 libfastjson4 libfdisk1 libfdt1 libffi7 libffmpegthumbnailer4v5 libfftw3-double3 libfftw3-single3 libfido2-1 libfile-basedir-perl libfile-desktopentry-perl libfile-fcntllock-perl libfile-listing-perl libfile-mimeinfo-perl libflac8 libflite1 libfltk1.1 libfluidsynth2 libfont-afm-perl libfontconfig1 libfontenc1 libfreetype6 libfribidi0 libfstrm0 libfuse2 libfuse3-3 libgail-common libgail18 libgarcon-1-0 libgarcon-common libgarcon-gtk3-1-0 libgbm1 libgcc-s1 libgck-1-0 libgcr-base-3-1 libgcr-ui-3-1 libgcrypt20 libgd3 libgdata-common libgdata22 libgdbm-compat4 libgdbm6 libgdk-pixbuf-2.0-0 libgdk-pixbuf-xlib-2.0-0 libgdk-pixbuf2.0-0 libgdk-pixbuf2.0-bin libgdk-pixbuf2.0-common libgepub-0.6-0 libgfortran5 libgif7 libgirepository-1.0-1 libgl1-mesa-dri libgl1 libglapi-mesa libgles2 libglib2.0-0 libglib2.0-bin libglib2.0-data libglibmm-2.4-1v5 libglu1-mesa libglvnd0 libglx-mesa0 libglx0 libgme0 libgmp10 libgnome-desktop-3-19 libgnutls30 libgoa-1.0-0b libgoa-1.0-common libgomp1 libgpg-error0 libgpgme11 libgphoto2-6 libgphoto2-l10n libgphoto2-port12 libgpm2 libgraphene-1.0-0 libgraphite2-3 libgs9-common libgs9 libgsf-1-114 libgsf-1-common libgsm1 libgssapi-krb5-2 libgssdp-1.2-0 libgstreamer-gl1.0-0 libgstreamer-plugins-bad1.0-0 libgstreamer-plugins-base1.0-0 libgstreamer1.0-0 libgtk-3-0 libgtk-3-bin libgtk-3-common libgtk2.0-0 libgtk2.0-bin libgtk2.0-common libgtkmm-3.0-1v5 libgtksourceview-3.0-1 libgtksourceview-3.0-common libgtop-2.0-11 libgtop2-common libgudev-1.0-0 libgupnp-1.2-0 libgupnp-igd-1.0-4 libgusb2 libgxps2 libharfbuzz-icu0 libharfbuzz0b libhogweed6 libhtml-form-perl libhtml-format-perl libhtml-parser-perl libhtml-tagset-perl libhtml-tree-perl libhttp-cookies-perl libhttp-daemon-perl libhttp-date-perl libhttp-message-perl libhttp-negotiate-perl libhunspell-1.7-0 libhyphen0 libical3 libice6 libicu67 libid3tag0 libidn11 libidn2-0 libiec61883-0 libieee1284-3 libijs-0.35 libilmbase25 libimlib2 libimobiledevice6 libinput-bin libinput10 libinstpatch-1.0-2 libio-html-perl libio-socket-ssl-perl libio-stringy-perl libip4tc2 libip6tc2 libipc-system-simple-perl libisc-export1105 libisl23 libisofs6 libiw30 libjack-jackd2-0 libjansson4 libjavascriptcoregtk-4.0-18 libjbig0 libjbig2dec0 libjim0.79 libjpeg62-turbo libjs-mathjax libjson-c5 libjson-glib-1.0-0 libjson-glib-1.0-common libjte2 libk5crypto3 libkate1 libkeybinder-3.0-0 libkeyutils1 libklibc libkmod2 libkpathsea6 libkrb5-3 libkrb5support0 libksba8 liblapack3 liblcms2-2 libldap-2.4-2 libldap-common libldb2 liblightdm-gobject-1-0 liblilv-0-0 libllvm11 liblmdb0 liblocale-gettext-perl liblognorm5 libltc11 libltdl7 liblua5.3-0 liblwp-mediatypes-perl liblwp-protocol-https-perl liblz4-1 liblzma5 liblzo2-2 libmagic-mgc libmagic1 libmailtools-perl libmanette-0.2-0 libmaxminddb0 libmbim-glib4 libmbim-proxy libmd0 libmjpegutils-2.1-0 libmm-glib0 libmms0 libmnl0 libmodplug1 libmount1 libmp3lame0 libmpc3 libmpcdec6 libmpdec3 libmpeg2encpp-2.1-0 libmpfr6 libmpg123-0 libmplex2-2.1-0 libmtdev1 libmtp-common libmtp-runtime libmtp9 libmysofa1 libncurses6 libncursesw6 libndp0 libnet-dbus-perl libnet-http-perl libnet-smtp-ssl-perl libnet-ssleay-perl libnetfilter-conntrack3 libnettle8 libnewt0.52 libnfnetlink0 libnfs13 libnftables1 libnftnl11 libnghttp2-14 libnice10 libnl-3-200 libnl-genl-3-200 libnl-route-3-200 libnm0 libnma-common libnma0 libnorm1 libnotify-bin libnotify4 libnpth0 libnsl2 libnspr4 libnss-mdns libnss-systemd libnss3 libntfs-3g883 libofa0 libogg0 libopenal-data libopenal1 libopenexr25 libopenjp2-7 libopenmpt0 libopenni2-0 libopenraw7 libopenrawgnome7 libopus0 liborc-0.4-0 libp11-kit0 libpam-gnome-keyring libpam-modules-bin libpam-modules libpam-runtime libpam-systemd libpam0g libpango-1.0-0 libpangocairo-1.0-0 libpangoft2-1.0-0 libpangomm-1.4-1v5 libpangoxft-1.0-0 libpaper-utils libpaper1 libparted-fs-resize0 libparted2 libpcap0.8 libpci3 libpciaccess0 libpcre2-8-0 libpcre3 libpcsclite1 libperl5.32 libpgm-5.3-0 libpipeline1 libpipewire-0.3-0 libpipewire-0.3-modules libpixman-1-0 libplist3 libpng16-16 libpocketsphinx3 libpolkit-agent-1-0 libpolkit-gobject-1-0 libpoppler-glib8 libpoppler102 libpopt0 libpostproc55 libprocps8 libprotobuf-c1 libproxy1v5 libpsl5 libpulse-mainloop-glib0 libpulse0 libpulsedsp libpython3-stdlib libpython3.9-minimal libpython3.9-stdlib libpython3.9 libqmi-glib5 libqmi-proxy libqrencode4 librabbitmq4 libraw1394-11 libreadline8 librest-0.7-0 librsvg2-2 librsvg2-common librtmp1 librubberband2 libsamplerate0 libsane-common libsane1 libsasl2-2 libsasl2-modules-db libsasl2-modules libsbc1 libsdl2-2.0-0 libseccomp2 libsecret-1-0 libsecret-common libselinux1 libsemanage-common libsemanage1 libsensors-config libsensors5 libsepol1 libserd-0-0 libshine3 libshout3 libsigc++-2.0-0v5 libslang2 libsm6 libsmartcols1 libsmbclient libsnappy1v5 libsndfile1 libsndio7.0 libsnmp-base libsnmp40 libsodium23 libsord-0-0 libsoundtouch1 libsoup-gnome2.4-1 libsoup2.4-1 libsoxr0 libspa-0.2-modules libspandsp2 libspectre1 libspeex1 libspeexdsp1 libsphinxbase3 libsqlite3-0 libsratom-0-0 libsrt1.4-gnutls libsrtp2-1 libss2 libssh-gcrypt-4 libssh2-1 libssl-dev libssl1.1 libstartup-notification0 libstdc++6 libswresample3 libswscale5 libsynctex2 libsystemd0 libtag1v5-vanilla libtag1v5 libtagc0 libtalloc2 libtasn1-6 libtdb1 libteamdctl0 libtevent0 libtext-charwidth-perl libtext-iconv-perl libtext-wrapi18n-perl libthai-data libthai0 libtheora0 libthunarx-3-0 libtie-ixhash-perl libtiff5 libtimedate-perl libtinfo6 libtirpc-common libtirpc3 libtry-tiny-perl libtumbler-1-0 libtwolame0 libubootenv-tool libubootenv0.1 libuchardet0 libudev1 libudfread0 libudisks2-0 libunistring2 libunwind8 libupower-glib3 liburi-perl libusb-1.0-0 libusbmuxd6 libutempter0 libuuid1 libuv1 libv4l-0 libv4lconvert0 libva-drm2 libva-x11-2 libva2 libvdpau-va-gl1 libvdpau1 libvidstab1.1 libvisual-0.4-0 libvo-aacenc0 libvo-amrwbenc0 libvolume-key1 libvorbis0a libvorbisenc2 libvorbisfile3 libvpx6 libvte-2.91-0 libvte-2.91-common libvulkan1 libwacom-bin libwacom-common libwacom2 libwavpack1 libwayland-client0 libwayland-cursor0 libwayland-egl1 libwayland-server0 libwbclient0 libwebkit2gtk-4.0-37 libwebp6 libwebpdemux2 libwebpmux3 libwebrtc-audio-processing1 libwildmidi2 libwnck-3-0 libwnck-3-common libwoff1 libwpe-1.0-1 libwpebackend-fdo-1.0-1 libwrap0 libwww-perl libwww-robotrules-perl libx11-6 libx11-data libx11-protocol-perl libx11-xcb1 libx264-160 libx265-192 libxapian30 libxau6 libxaw7 libxcb-dri2-0 libxcb-dri3-0 libxcb-glx0 libxcb-present0 libxcb-randr0 libxcb-render0 libxcb-shape0 libxcb-shm0 libxcb-sync1 libxcb-util1 libxcb-xfixes0 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxdmcp6 libxext6 libxfce4panel-2.0-4 libxfce4ui-2-0 libxfce4ui-common libxfce4ui-utils libxfce4util-bin libxfce4util-common libxfce4util7 libxfconf-0-3 libxfixes3 libxfont2 libxft2 libxi6 libxinerama1 libxkbcommon0 libxkbfile1 libxkbregistry0 libxklavier16 libxml-parser-perl libxml-twig-perl libxml-xpathengine-perl libxml2 libxmu6 libxmuu1 libxnvctrl0 libxpm4 libxpresent1 libxrandr2 libxrender1 libxres1 libxshmfence1 libxslt1.1 libxss1 libxt6 libxtables12 libxtst6 libxv1 libxvidcore4 libxxf86dga1 libxxf86vm1 libxxhash0 libyaml-0-2 libz3-4 libzbar0 libzmq5 libzstd1 libzvbi-common libzvbi0 lightdm-gtk-greeter-settings lightdm-gtk-greeter lightdm-settings linux-base linux-cpupower lm-sensors locales-all locales login logrotate logsave lsb-base lsb-release lsof mailcap man-db mawk mc-data mc media-types mesa-va-drivers mesa-vdpau-drivers mesa-vulkan-drivers mime-support mobile-broadband-provider-info modemmanager mount mousepad nano ncurses-base ncurses-bin net-tools netbase network-manager-gnome network-manager nftables nodm notification-daemon ntfs-3g ntpdate ocl-icd-libopencl1 openssh-client openssl p11-kit-modules p11-kit p7zip-full p7zip parole parted passwd patch pavucontrol pci.ids pcscd perl-base perl-modules-5.32 perl-openssl-defaults perl pigz pinentry-curses pinentry-gnome3 pipewire-bin pipewire pocketsphinx-en-us policykit-1-gnome policykit-1 poppler-data ppp procps psmisc publicsuffix pulseaudio-utils pulseaudio python-apt-common python3-apt python3-chardet python3-debian python3-gi python3-idna python3-ldb python3-minimal python3-pkg-resources python3-psutil python3-setproctitle python3-six python3-talloc python3-urllib3 python3-xapp python3.9-minimal python3.9 python3 readline-common rfkill ristretto rsyslog rtkit samba-libs sane-utils sed sensible-utils shared-mime-info shiki-colors-xfwm-theme sound-theme-freedesktop systemd-sysv systemd-timesyncd systemd sysvinit-utils tango-icon-theme tar thunar-archive-plugin thunar-data thunar-media-tags-plugin thunar-volman thunar timgm6mb-soundfont tmux tumbler-common tumbler-plugins-extra tumbler tzdata u-boot-tools ucf udev udisks2 unzip update-inetd upower usb-modeswitch-data usb-modeswitch usb.ids usbmuxd usbutils util-linux va-driver-all vala-panel-appmenu-common vboot-kernel-utils vboot-utils vdpau-driver-all vim-common vim-tiny wget whiptail wireless-regdb wpasupplicant x11-apps x11-common x11-session-utils x11-utils x11-xkb-utils x11-xserver-utils xarchiver xauth xbitmaps xdg-dbus-proxy xdg-desktop-portal-gtk xdg-desktop-portal xdg-user-dirs xdg-utils xfburn xfce4-appfinder xfce4-appmenu-plugin xfce4-battery-plugin xfce4-clipman-plugin xfce4-clipman xfce4-cpufreq-plugin xfce4-cpugraph-plugin xfce4-datetime-plugin xfce4-dict xfce4-diskperf-plugin xfce4-fsguard-plugin xfce4-genmon-plugin xfce4-goodies xfce4-helpers xfce4-indicator-plugin xfce4-mailwatch-plugin xfce4-mount-plugin xfce4-netload-plugin xfce4-notifyd xfce4-panel xfce4-places-plugin xfce4-power-manager-data xfce4-power-manager-plugins xfce4-power-manager xfce4-pulseaudio-plugin xfce4-screenshooter xfce4-sensors-plugin xfce4-session xfce4-settings xfce4-smartbookmark-plugin xfce4-systemload-plugin xfce4-taskmanager xfce4-terminal xfce4-timer-plugin xfce4-verve-plugin xfce4-wavelan-plugin xfce4-weather-plugin xfce4-whiskermenu-plugin xfce4-xkb-plugin xfce4 xfconf xfdesktop4-data xfdesktop4 xfonts-100dpi xfonts-75dpi xfonts-base xfonts-encodings xfonts-scalable xfonts-terminus xfonts-utils xfwm4 xiccd xinit xinput xkb-data xorg-docs-core xorg xserver-common xserver-xorg-core xserver-xorg-input-libinput xserver-xorg-input-synaptics xserver-xorg-legacy xserver-xorg-video-fbdev xserver-xorg xterm xxd xz-utils zip zlib1g'
depends="cgpt"
suggests='vboot-kernel-utils,vboot-utils'
replaces="linux-image-armmp,linux-image-armmp-lpae,linux-headers-armmp,linux-headers-armmp-lpae"
provides="linux-image-generic,linux-headers-generic"
sourcelist='deb http://http.kali.org/kali kali-rolling main contrib non-free
deb-src http://http.kali.org/kali kali-rolling main contrib non-free'
firmware_dir="/usr/lib/firmware"
nir="--no-install-recommends"

## checks
if [ $(whoami) != root ];then echo ''; echo root rights are required, try to run with sudo; echo ''; exit 1; fi

for ((tmpvar=1;tmpvar<=$#;tmpvar++)); do
    
    tmpvalue=$(eval 'echo ${'$tmpvar'}')
    
    if [ $tmpvalue == ck ]||[ $tmpvalue == bts ]||[ $tmpvalue == bdi ];then
        stages="$stages $tmpvalue"
    elif [ $tmpvalue == kali ];then
        echo '"'Kali defauilts'"' will be used
    elif [ $tmpvalue == devuan ]||[ $tmpvalue == devuan-lxqt ];then
        mirror=deb.devuan.org
        sourcelist='deb http://deb.devuan.org/merged chimaera          main non-free contrib
deb http://deb.devuan.org/merged chimaera-updates  main non-free contrib
deb http://deb.devuan.org/merged chimaera-security main non-free contrib'
        target_hostname=devuan
        sources_list="$sourcelist"
        debootstrap_string="debootstrap --foreign --arch $architecture chimaera $target_hostname-$architecture http://deb.devuan.org/merged"
        basedir="$(pwd)/$target_hostname-exynos"
        if [ $tmpvalue == devuan-lxqt ];then
            targetpackages='adduser adwaita-icon-theme alsa-topology-conf alsa-ucm-conf alsa-utils apt-transport-https apt-utils apt aptitude-common aptitude ark at-spi2-core base-files base-passwd bash-completion bash bc bluez bootlogd bsdextrautils bsdutils btrfs-progs busybox bzip2 ca-certificates calibre-bin calibre cgpt conky-std console-common console-data console-setup-linux console-setup coreutils cpio crda cron cryptsetup-bin cryptsetup-initramfs cryptsetup-run cryptsetup cups-pk-helper curl dash dbus-x11 dbus dconf-gsettings-backend dconf-service debconf-i18n debconf debian-archive-keyring debianutils desktop-file-utils devuan-keyring dialog dictionaries-common diffutils dirmngr dmidecode dmsetup dns-root-data dnsmasq-base dosfstools dpkg e2fsprogs easy-rsa ecryptfs-utils eject elogind emacsen-common eudev exfat-fuse exfat-utils f2fs-tools fdisk ffmpeg file findutils firefox-esr fontconfig-config fontconfig fonts-dejavu-core fonts-dejavu-extra fonts-dejavu fonts-freefont-ttf fonts-liberation2 fonts-mathjax fonts-urw-base35 fuse3 galternatives gcc-10-base gcc-9-base gcr gdisk gettext-base giblib1 gir1.2-atk-1.0 gir1.2-freedesktop gir1.2-gdkpixbuf-2.0 gir1.2-glib-2.0 gir1.2-gtk-3.0 gir1.2-harfbuzz-0.0 gir1.2-notify-0.7 gir1.2-packagekitglib-1.0 gir1.2-pango-1.0 gir1.2-polkit-1.0 gir1.2-secret-1 git-man git glib-networking-common glib-networking-services glib-networking gnome-keyring-pkcs11 gnome-keyring gnupg-l10n gnupg-utils gnupg2 gnupg gpg-agent gpg-wks-client gpg-wks-server gpg gpgconf gpgsm gpgv grep groff-base gsettings-desktop-schemas gsfonts-x11 gsfonts gtk-update-icon-cache gvfs-backends gvfs-common gvfs-daemons gvfs-fuse gvfs-libs gvfs gwenview gzip hicolor-icon-theme hostname hwdata ifupdown imagemagick-6-common imagemagick-6.q16 imagemagick init-system-helpers init initramfs-tools-core initramfs-tools initscripts insserv iproute2 iptables iputils-ping isc-dhcp-client isc-dhcp-common iw kate5-data kate kbd kded5 keyboard-configuration keyutils kinit kio klibc-utils kmod kpackagetool5 ktexteditor-data ktexteditor-katepart kwayland-data less liba52-0.7.4 libaa1 libaccounts-glib0 libaccounts-qt5-1 libacl1 libaom0 libapparmor1 libappstream4 libapt-pkg6.0 libarchive13 libargon2-1 libaribb24-0 libasound2-data libasound2 libass9 libassuan0 libasyncns0 libatasmart4 libatk-bridge2.0-0 libatk1.0-0 libatk1.0-data libatopology2 libatspi2.0-0 libattr1 libaudit-common libaudit1 libauthen-sasl-perl libavahi-client3 libavahi-common-data libavahi-common3 libavahi-glib1 libavc1394-0 libavcodec58 libavdevice58 libavfilter7 libavformat58 libavresample4 libavutil56 libblas3 libblkid1 libblockdev-crypto2 libblockdev-fs2 libblockdev-loop2 libblockdev-part-err2 libblockdev-part2 libblockdev-swap2 libblockdev-utils2 libblockdev2 libbluetooth3 libbluray2 libboost-iostreams1.74.0 libbpf0 libbrotli1 libbs2b0 libbsd0 libbz2-1.0 libc-bin libc-l10n libc6 libcaca0 libcairo-gobject2 libcairo2 libcap-ng0 libcap2-bin libcap2 libcbor0 libccid libcddb2 libcdio-cdda2 libcdio-paranoia2 libcdio19 libcfitsio9 libchm1 libchromaprint1 libclone-perl libcodec2-0.9 libcolord2 libcom-err2 libcrypt1 libcryptsetup12 libcups2 libcurl3-gnutls libcurl4 libcurses-perl libcurses-ui-perl libcwidget4 libdata-dump-perl libdatrie1 libdav1d4 libdb5.3 libdbus-1-3 libdbus-glib-1-2 libdbusmenu-qt5-2 libdc1394-25 libdca0 libdconf1 libde265-0 libdebconfclient0 libdeflate0 libdevmapper1.02.1 libdns-export1110 libdouble-conversion3 libdpkg-perl libdrm-amdgpu1 libdrm-common libdrm-nouveau2 libdrm-radeon1 libdrm2 libdvbpsi10 libdvdnav4 libdvdread8 libdw1 libebml5 libecryptfs1 libedit2 libeditorconfig0 libegl-mesa0 libegl1 libelf1 libelogind0 libencode-locale-perl libepoxy0 liberror-perl libestr0 libeudev1 libevdev2 libevent-2.1-7 libexif12 libexiv2-27 libexpat1 libext2fs2 libfaad2 libfam0 libfastjson4 libfdisk1 libffi7 libfftw3-double3 libfftw3-single3 libfido2-1 libfile-basedir-perl libfile-desktopentry-perl libfile-fcntllock-perl libfile-listing-perl libfile-mimeinfo-perl libflac8 libflite1 libfm-extra4 libfm-qt-l10n libfm-qt8 libfont-afm-perl libfontconfig1 libfontenc1 libfreetype6 libfribidi0 libfuse2 libfuse3-3 libgail-common libgail18 libgbm1 libgcc-s1 libgck-1-0 libgcr-base-3-1 libgcr-ui-3-1 libgcrypt20 libgd3 libgdata-common libgdata22 libgdbm-compat4 libgdbm6 libgdk-pixbuf-2.0-0 libgdk-pixbuf-xlib-2.0-0 libgdk-pixbuf2.0-0 libgdk-pixbuf2.0-bin libgdk-pixbuf2.0-common libgfortran5 libgif7 libgirepository-1.0-1 libgit2-1.1 libgl1-mesa-dri libgl1 libglapi-mesa libgles2 libglib2.0-0 libglib2.0-bin libglib2.0-data libglvnd0 libglx-mesa0 libglx0 libgme0 libgmp10 libgnutls30 libgoa-1.0-0b libgoa-1.0-common libgomp1 libgpg-error0 libgpgme11 libgpgmepp6 libgphoto2-6 libgphoto2-l10n libgphoto2-port12 libgpm2 libgraphite2-3 libgs9-common libgs9 libgsm1 libgssapi-krb5-2 libgstreamer1.0-0 libgtk-3-0 libgtk-3-bin libgtk-3-common libgtk2.0-0 libgtk2.0-bin libgtk2.0-common libgudev-1.0-0 libharfbuzz0b libheif1 libhogweed6 libhtml-form-perl libhtml-format-perl libhtml-parser-perl libhtml-tagset-perl libhtml-tree-perl libhttp-cookies-perl libhttp-daemon-perl libhttp-date-perl libhttp-message-perl libhttp-negotiate-perl libhttp-parser2.9 libhunspell-1.7-0 libhunspell-dev libhyphen0 libice6 libicu67 libid3tag0 libidn11 libidn2-0 libiec61883-0 libijs-0.35 libimagequant0 libimlib2 libimobiledevice6 libinput-bin libinput10 libio-html-perl libio-socket-ssl-perl libio-stringy-perl libip4tc2 libip6tc2 libipc-system-simple-perl libisc-export1105 libiw30 libixml10 libjack-jackd2-0 libjansson4 libjbig0 libjbig2dec0 libjpeg-turbo-progs libjpeg62-turbo libjs-jquery-scrollto libjs-jquery libjs-mathjax libjs-sphinxdoc libjs-underscore libjson-c5 libjson-glib-1.0-0 libjson-glib-1.0-common libjxr-tools libjxr0 libk5crypto3 libkaccounts2 libkate1 libkeyutils1 libkf5activities5 libkf5archive5 libkf5attica5 libkf5auth-data libkf5authcore5 libkf5baloo5 libkf5balooengine5 libkf5bluezqt-data libkf5bluezqt6 libkf5bookmarks-data libkf5bookmarks5 libkf5calendarevents5 libkf5codecs-data libkf5codecs5 libkf5completion-data libkf5completion5 libkf5config-data libkf5configcore5 libkf5configgui5 libkf5configwidgets-data libkf5configwidgets5 libkf5coreaddons-data libkf5coreaddons5 libkf5crash5 libkf5dbusaddons-data libkf5dbusaddons5 libkf5declarative-data libkf5declarative5 libkf5doctools5 libkf5filemetadata-data libkf5filemetadata3 libkf5globalaccel-bin libkf5globalaccel-data libkf5globalaccel5 libkf5globalaccelprivate5 libkf5guiaddons5 libkf5i18n-data libkf5i18n5 libkf5iconthemes-data libkf5iconthemes5 libkf5idletime5 libkf5itemmodels5 libkf5itemviews-data libkf5itemviews5 libkf5jobwidgets-data libkf5jobwidgets5 libkf5js5 libkf5jsapi5 libkf5kdcraw5 libkf5kexiv2-15.0.0 libkf5kiocore5 libkf5kiofilewidgets5 libkf5kiogui5 libkf5kiontlm5 libkf5kiowidgets5 libkf5kipi-data libkf5kipi32.0.0 libkf5networkmanagerqt6 libkf5newstuff-data libkf5newstuff5 libkf5newstuffcore5 libkf5notifications-data libkf5notifications5 libkf5package-data libkf5package5 libkf5parts-data libkf5parts5 libkf5plasma5 libkf5plasmaquick5 libkf5pty-data libkf5pty5 libkf5purpose-bin libkf5purpose5 libkf5quickaddons5 libkf5screen-bin libkf5screen7 libkf5service-bin libkf5service-data libkf5service5 libkf5solid5-data libkf5solid5 libkf5sonnet5-data libkf5sonnetcore5 libkf5sonnetui5 libkf5syntaxhighlighting-data libkf5syntaxhighlighting5 libkf5texteditor-bin libkf5texteditor5 libkf5textwidgets-data libkf5textwidgets5 libkf5threadweaver5 libkf5wallet-bin libkf5wallet-data libkf5wallet5 libkf5waylandclient5 libkf5widgetsaddons-data libkf5widgetsaddons5 libkf5windowsystem-data libkf5windowsystem5 libkf5xmlgui-data libkf5xmlgui5 libklibc libkmod2 libkrb5-3 libkrb5support0 libksba8 libkuserfeedbackcore1 libkuserfeedbackwidgets1 libkwalletbackend5-5 liblapack3 liblcms2-2 libldap-2.4-2 libldap-common libldb2 liblilv-0-0 liblirc-client0 libllvm11 liblmdb0 liblocale-gettext-perl liblognorm5 liblqr-1-0 libltdl7 liblua5.2-0 liblua5.3-0 liblwp-mediatypes-perl liblwp-protocol-https-perl liblxqt-globalkeys-ui0 liblxqt-globalkeys0 liblxqt-l10n liblxqt0 liblz4-1 liblzma5 liblzo2-2 libmad0 libmagic-mgc libmagic1 libmagickcore-6.q16-6 libmagickwand-6.q16-6 libmailtools-perl libmatroska7 libmbedcrypto3 libmbedtls12 libmbedx509-0 libmd0 libmd4c0 libmenu-cache-bin libmenu-cache3 libminizip1 libmm-glib0 libmng1 libmnl0 libmount1 libmp3lame0 libmpcdec6 libmpdec3 libmpeg2-4 libmpg123-0 libmtdev1 libmtp-common libmtp-runtime libmtp9 libmuparser2v5 libmysofa1 libncurses6 libncursesw6 libndp0 libnet-http-perl libnet-smtp-ssl-perl libnet-ssleay-perl libnetfilter-conntrack3 libnettle8 libnewt0.52 libnfnetlink0 libnfs13 libnftables1 libnftnl11 libnghttp2-14 libnl-3-200 libnl-genl-3-200 libnl-route-3-200 libnm0 libnorm1 libnotify4 libnpth0 libnsl2 libnspr4 libnss3 libntfs-3g883 libobrender32v5 libobt2v5 libogg0 libokular5core9 libopenal-data libopenal1 libopenjp2-7 libopenmpt-modplug1 libopenmpt0 libopus0 libp11-kit0 libpackagekit-glib2-18 libpam-elogind libpam-gnome-keyring libpam-modules-bin libpam-modules libpam-runtime libpam0g libpango-1.0-0 libpangocairo-1.0-0 libpangoft2-1.0-0 libpangoxft-1.0-0 libpaper1 libparted-fs-resize0 libparted2 libpcap0.8 libpciaccess0 libpcre16-3 libpcre2-16-0 libpcre2-8-0 libpcre3 libpcsclite1 libperl5.32 libpgm-5.3-0 libphonon4qt5-4 libphonon4qt5-data libpipeline1 libpixman-1-0 libpkcs11-helper1 libplacebo72 libplist3 libpng16-16 libpocketsphinx3 libpodofo0.9.7 libpolkit-agent-1-0 libpolkit-gobject-1-0 libpolkit-gobject-elogind-1-0 libpolkit-qt5-1-1 libpoppler-qt5-1 libpoppler102 libpopt0 libpostproc55 libprocps8 libprotobuf-lite23 libproxy1v5 libpsl5 libpulse-mainloop-glib0 libpulse0 libpython3-stdlib libpython3.9-minimal libpython3.9-stdlib libpython3.9 libqmobipocket2 libqt5concurrent5 libqt5core5a libqt5dbus5 libqt5designer5 libqt5gui5 libqt5help5 libqt5network5 libqt5positioning5 libqt5printsupport5 libqt5qml5 libqt5qmlmodels5 libqt5qmlworkerscript5 libqt5quick5 libqt5quickcontrols2-5 libqt5quicktemplates2-5 libqt5quickwidgets5 libqt5sql5-sqlite libqt5sql5 libqt5svg5 libqt5test5 libqt5texttospeech5 libqt5waylandclient5 libqt5webchannel5 libqt5webengine-data libqt5webengine5 libqt5webenginecore5 libqt5webenginewidgets5 libqt5widgets5 libqt5x11extras5 libqt5xdg3 libqt5xdgiconloader3 libqt5xml5 librabbitmq4 libraw1394-11 libraw20 libre2-9 libreadline8 libresid-builder0c2a librest-0.7-0 librsvg2-2 librsvg2-common librtmp1 librubberband2 libsamplerate0 libsasl2-2 libsasl2-modules-db libsasl2-modules libsdl-image1.2 libsdl1.2debian libsdl2-2.0-0 libseccomp2 libsecret-1-0 libsecret-common libselinux1 libsemanage-common libsemanage1 libsensors-config libsensors5 libsepol1 libserd-0-0 libshine3 libshout3 libsidplay2 libsigc++-2.0-0v5 libsignon-qt5-1 libslang2 libsm6 libsmartcols1 libsmbclient libsnappy1v5 libsndfile1 libsndio7.0 libsodium23 libsord-0-0 libsoup-gnome2.4-1 libsoup2.4-1 libsoxr0 libspatialaudio0 libspectre1 libspeex1 libspeexdsp1 libsphinxbase3 libsqlite3-0 libsratom-0-0 libsrt1.4-gnutls libss2 libssh-gcrypt-4 libssh2-1 libssl-dev libssl1.1 libstartup-notification0 libstatgrab10 libstdc++6 libstemmer0d libswresample3 libswscale5 libsysstat-qt5-0 libtag1v5-vanilla libtag1v5 libtalloc2 libtasn1-6 libtdb1 libteamdctl0 libterm-readkey-perl libtevent0 libtext-charwidth-perl libtext-iconv-perl libtext-wrapi18n-perl libthai-data libthai0 libtheora0 libtiff5 libtimedate-perl libtinfo6 libtirpc-common libtirpc3 libtry-tiny-perl libtspi1 libturbojpeg0 libtwolame0 libubootenv-tool libubootenv0.1 libuchardet0 libudfread0 libudisks2-0 libunistring2 libunwind8 libupnp13 libupower-glib3 liburi-perl libusb-1.0-0 libusbmuxd6 libuuid1 libva-drm2 libva-wayland2 libva-x11-2 libva2 libvdpau-va-gl1 libvdpau1 libvidstab1.1 libvlc-bin libvlc5 libvlccore9 libvolume-key1 libvorbis0a libvorbisenc2 libvorbisfile3 libvpx6 libvte-2.91-0 libvte-2.91-common libvulkan1 libwacom-bin libwacom-common libwacom2 libwavpack1 libwayland-client0 libwayland-cursor0 libwayland-egl1 libwayland-server0 libwbclient0 libwebp6 libwebpdemux2 libwebpmux3 libwnck-3-0 libwnck-3-common libwrap0 libwww-perl libwww-robotrules-perl libx11-6 libx11-data libx11-xcb1 libx264-160 libx265-192 libxapian30 libxau6 libxaw7 libxcb-composite0 libxcb-damage0 libxcb-dri2-0 libxcb-dri3-0 libxcb-glx0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-present0 libxcb-randr0 libxcb-render-util0 libxcb-render0 libxcb-res0 libxcb-shape0 libxcb-shm0 libxcb-sync1 libxcb-util1 libxcb-xfixes0 libxcb-xinerama0 libxcb-xinput0 libxcb-xkb1 libxcb-xv0 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxdmcp6 libxext6 libxfce4ui-2-0 libxfce4ui-common libxfce4util-bin libxfce4util-common libxfce4util7 libxfconf-0-3 libxfixes3 libxfont2 libxft2 libxi6 libxinerama1 libxkbcommon-x11-0 libxkbcommon0 libxkbfile1 libxml2 libxmu6 libxmuu1 libxpm4 libxpresent1 libxrandr2 libxrender1 libxres1 libxshmfence1 libxslt1.1 libxss1 libxt6 libxtables12 libxtst6 libxv1 libxvidcore4 libxxf86dga1 libxxf86vm1 libxxhash0 libyaml-0-2 libz3-4 libzip4 libzmq5 libzstd1 libzvbi-common libzvbi0 linux-base linux-kernel-xe303c12 locales-all locales login logrotate logsave lsb-base lsof lximage-qt-l10n lximage-qt lxmenu-data lxqt-admin-l10n lxqt-admin lxqt-archiver-l10n lxqt-archiver lxqt-config-l10n lxqt-config lxqt-globalkeys-l10n lxqt-globalkeys lxqt-notificationd-l10n lxqt-notificationd lxqt-openssh-askpass-l10n lxqt-openssh-askpass lxqt-panel-l10n lxqt-panel lxqt-policykit-l10n lxqt-policykit lxqt-powermanagement-l10n lxqt-powermanagement lxqt-qtplugin lxqt-runner-l10n lxqt-runner lxqt-session-l10n lxqt-session lxqt-sudo-l10n lxqt-sudo lxqt-system-theme lxqt-themes mailcap man-db mawk mc-data mc media-player-info media-types mesa-va-drivers mesa-vdpau-drivers mesa-vulkan-drivers mime-support miscfiles mlocate mount mpv nano ncurses-base ncurses-bin net-tools netbase netcat-traditional network-manager-config-connectivity-debian network-manager-openvpn network-manager nftables nm-tray-l10n nm-tray nodm notification-daemon ntfs-3g ntpdate obconf obsession ocl-icd-libopencl1 okular openbox opensc-pkcs11 opensc openssh-client openssl openvpn optipng p11-kit-modules p11-kit p7zip-full p7zip packagekit-tools packagekit papirus-icon-theme parted passwd patch pci.ids pcmanfm-qt-l10n pcmanfm-qt pcscd perl-base perl-modules-5.32 perl-openssl-defaults perl-tk perl phonon4qt5-backend-vlc phonon4qt5 pigz pinentry-curses pinentry-gnome3 plasma-framework pocketsphinx-en-us policykit-1-gnome policykit-1 poppler-data poppler-utils ppp procps psmisc publicsuffix python3-apsw python3-bs4 python3-cairo python3-certifi python3-chardet python3-chm python3-css-parser python3-cssselect python3-cssutils python3-cups python3-cupshelpers python3-dateutil python3-dbus python3-dulwich python3-feedparser python3-gi python3-html2text python3-html5-parser python3-html5lib python3-idna python3-ifaddr python3-ldb python3-lxml python3-markdown python3-mechanize python3-minimal python3-msgpack python3-netifaces python3-pil python3-pkg-resources python3-py7zr python3-pycryptodome python3-pygments python3-pyparsing python3-pyqt5.qtsvg python3-pyqt5.qtwebchannel python3-pyqt5.qtwebengine python3-pyqt5.sip python3-pyqt5 python3-pyxattr python3-regex python3-repoze.lru python3-requests python3-routes python3-six python3-smbc python3-soupsieve python3-speechd python3-talloc python3-texttable python3-urllib3 python3-webencodings python3-xdg python3-zeroconf python3.9-minimal python3.9 python3 qlipper qml-module-org-kde-bluezqt qml-module-org-kde-kconfig qml-module-org-kde-kquickcontrols qml-module-org-kde-kquickcontrolsaddons qml-module-qt-labs-folderlistmodel qml-module-qt-labs-settings qml-module-qtgraphicaleffects qml-module-qtqml-models2 qml-module-qtqml qml-module-qtquick-controls2 qml-module-qtquick-controls qml-module-qtquick-dialogs qml-module-qtquick-layouts qml-module-qtquick-privatewidgets qml-module-qtquick-templates2 qml-module-qtquick-window2 qml-module-qtquick2 qps qt5-gtk-platformtheme qt5-gtk2-platformtheme qt5-image-formats-plugins qt5-style-plugin-cleanlooks qt5-style-plugin-motif qt5-style-plugin-plastique qt5-style-plugins qttranslations5-l10n readline-common rfkill rsyslog rtmpdump samba-libs scrot sed sensible-utils shared-mime-info sigil-data sigil startpar sudo system-config-printer-common system-config-printer-udev system-config-printer sysv-rc-conf sysv-rc sysvinit-core sysvinit-utils sysvinit tar termit tzdata u-boot-tools ucf udev udisks2 unrar unzip upower usb.ids usbmuxd usbutils util-linux va-driver-all vdpau-driver-all vim-common vim-tiny vlc-data vlc-plugin-base vlc-plugin-video-output wget whiptail wireless-regdb wpasupplicant x11-common x11-utils x11-xkb-utils xauth xdg-user-dirs xdg-utils xfconf xfonts-100dpi xfonts-75dpi xfonts-base xfonts-encodings xfonts-scalable xfonts-utils xfwm4 xinit xinput xkb-data xkbset xscreensaver-data xscreensaver xserver-common xserver-xorg-core xserver-xorg-input-evdev xserver-xorg-input-kbd xserver-xorg-input-libinput xserver-xorg-input-mouse xserver-xorg-input-synaptics xserver-xorg-input-wacom xserver-xorg-legacy xserver-xorg-video-fbdev xserver-xorg-video-vesa xserver-xorg xsettingsd xxd xz-utils youtube-dl zerofree zip zlib1g'
        else
            targetpackages='adduser alsa-utils apt-transport-https apt-utils apt aptitude base-files base-passwd bash-completion bash bc binutils bison bluez bootlogd bsdutils btrfs-progs ca-certificates clearlooks-phenix-lightpurpy-theme conky console-common console-setup coreutils cpio cpufreqd cpufrequtils crda cron cryptsetup cups curl dash debconf-i18n debconf debian-archive-keyring debianutils devuan-keyring dialog diffutils dmidecode dpkg e2fsprogs ecryptfs-utils f2fs-tools fbreader fdisk ffmpeg ffmpegfs findutils firefox-esr gcc-10-base gcc-9-base geany-plugin-addons geany-plugin-autoclose geany-plugin-automark geany-plugin-codenav geany-plugin-commander geany-plugin-ctags geany-plugin-extrasel geany git gnome-icon-theme-gartoon gnome-icon-theme-yasis gnupg2 gpgv grep gvfs-backends gvfs-fuse gzip hostname ifupdown imagemagick-6.q16hdri imagemagick init-system-helpers init initramfs-tools initscripts insserv iproute2 iputils-ping isc-dhcp-client isc-dhcp-common iw kmod less libacl1 libapt-pkg6.0 libattr1 libaudit-common libaudit1 libblkid1 libbpf0 libbsd0 libbz2-1.0 libc-bin libc6 libcap-ng0 libcap2-bin libcap2 libcom-err2 libcpufreq0 libcrypt1 libdb5.3 libdebconfclient0 libdns-export1110 libedit2 libelf1 libestr0 libeudev1 libext2fs2 libfastjson4 libfdisk1 libffi7 libgcc-s1 libgcrypt20 libgmp10 libgnutls30 libgpg-error0 libgssapi-krb5-2 libhogweed6 libidn2-0 libisc-export1105 libjansson4 libk5crypto3 libkeyutils1 libkmod2 libkrb5-3 libkrb5support0 liblocale-gettext-perl liblognorm5 liblz4-1 liblzma5 libmd0 libmnl0 libmount1 libncurses6 libncursesw6 libnettle8 libnewt0.52 libnftables1 libnftnl11 libnsl2 libp11-kit0 libpam-modules-bin libpam-modules libpam-runtime libpam0g libpcre2-8-0 libpcre3 libpopt0 libprocps8 libreadline8 libseccomp2 libselinux1 libsemanage-common libsemanage1 libsepol1 libslang2 libsmartcols1 libss2 libssl-dev libssl1.1 libstdc++6 libsysfs2 libtasn1-6 libtext-charwidth-perl libtext-iconv-perl libtext-wrapi18n-perl libtinfo6 libtirpc-common libtirpc3 libunistring2 libuuid1 libxtables12 libxxhash0 libzstd1 linux-kernel-xe303c12 locales-all locales login logrotate logsave lsb-base lxdm man-db mawk mc mlocate mount mousepad nano ncurses-base ncurses-bin net-tools netbase netcat-traditional network-manager-gnome network-manager nftables ntpdate parted passwd perl-base potrace printer-driver-cups-pdf printer-driver-foo2zjs procps psmisc readline-common rfkill ristretto rsyslog sed sensible-utils shiki-colors-xfwm-theme startpar sudo sylpheed-plugins sylpheed sysv-rc-conf sysv-rc sysvinit-core sysvinit-utils sysvinit tar thunar-archive-plugin thunar-media-tags-plugin thunar tzdata u-boot-tools unrar usbutils util-linux vim-common vim-tiny wget whiptail wpasupplicant xfce4-appfinder xfce4-appmenu-plugin xfce4-battery-plugin xfce4-clipman-plugin xfce4-clipman xfce4-datetime-plugin xfce4-fsguard-plugin xfce4-indicator-plugin xfce4-mount-plugin xfce4-netload-plugin xfce4-panel xfce4-power-manager xfce4-screenshooter xfce4-sensors-plugin xfce4-session xfce4-settings xfce4-statusnotifier-plugin xfce4-taskmanager xfce4-terminal xfce4-timer-plugin xfce4-weather-plugin xfce4-whiskermenu-plugin xfce4-xkb-plugin xinput xorg xserver-xorg-input-all xserver-xorg-input-evdev xserver-xorg-input-mouse xserver-xorg-input-synaptics xserver-xorg-legacy xserver-xorg-video-qxl xsettingsd xxd youtube-dl zathura-cb zathura-djvu zathura-ps zathura zerofree zlib1g'
            nir=''
        fi
        #targetpackages+=" devuan-keyring"
        #targetpackages+=" sysv-rc sysvinit sysvinit-core sysvinit-utils"
        #targetpackages+=" runit rinit-helper runit-init"
        #targetpackages+=" s6"
        firmware_dir="/lib/firmware"
    elif [ $tmpvalue == btrfs ]||[ $tmpvalue == f2fs ];then
        fstype=$tmpvalue
    elif $(echo $tmpvalue | grep -q [0-9])&&$(echo $tmpvalue | grep -vq [a-zA-Z,.]);then
        if [ "$tmpvalue" -gt "2" ]&&[ "$tmpvalue" -lt "129" ];then
            disksize=$(($tmpvalue*1024+0))
        elif [ "$tmpvalue" -ge "1882" ]&&[ "$tmpvalue" -lt "131093" ]; then
            disksize=$(($tmpvalue+0))
        else
            echo ''
            echo "$tmpvalue out of range"
            echo "Disk image size is allowed at 2-128 (G) or 1882-131092 (M)"
            echo "or empty '' means default size (7 G). Root partition offset is 20Mb"
            echo "to set a disk image size use only numbers from that intervals"
            echo ''
            exit 1
        fi
        if [ $disksize -lt 5119 ]; then echo ''; echo disk size is too small, it could be smaller than your system, be aware; fi
    elif $(echo $tmpvalue | grep -q --regexp='.patch' --regexp='.diff') ;then
        patch=$tmpvalue
    else
        echo unknown parameter $tmpvalue
        exit 1
    fi
done

if [ -z "$stages" ]; then stages='ck bts bdi'; fi

echo "
Some build variables:"

echo "# hostpackages         : $hostpackages
# hostpackages (32bit) : $hostpackages_32bit"

if $(echo $stages | grep -q bts); then
    echo "# targetpackages       : $targetpackages
# debootstrap_string   : $debootstrap_string
# sources_list         : $sources_list
# targetpackages_2     : $targetpackages_2
# targetpackages_3     : $targetpackages_3
# sourcelist           : $sourcelist
# firmware_dir         : $firmware_dir
# extra directives     : $nir"
fi

echo "# target_hostname      : $target_hostname
# basedir              : $basedir
# mirror               : $mirror
# architecture         : $architecture
# stages:              : $stages"

if $(echo $stages | grep -q ck); then
    echo "# depends              : $depends
# suggests             : $suggests
# replaces             : $replaces
# provides             : $provides"
    if [ -z "$patch" ]; then
        echo "# kernel patch         : no patch? are you sure?"
    else
	echo "# kernel patch         : $patch"
    fi
fi

if $(echo $stages | grep -q bdi); then echo "# disk size            : $disksize M
# fstype               : $fstype"; fi

echo "
you may press Ctrl+C to abort
"
sleep 30
echo ' So lets run...'

## check and install required host packages

LANG=C apt list --installed | sed 's/\/.*//g'>/tmp/aptlist
need_install=""
for i in $hostpackages; do
    if ! $(grep $i /tmp/aptlist -xq); then 
        need_install+="$i "
    fi
done
rm -f /tmp/aptlist
if [ "$need_install" != "" ]; then
    apt-get install -y $need_install
    if [ "$(uname -m)" == 'x86_64' ]; then
        dpkg --add-architecture i386
        apt-get update
        apt-get install -y $(echo $hostpackages_32bit)
    else
        apt-get install -y libncurses5
    fi
    apt autoremove -y
fi
    
if [ ! -d "$basedir" ]; then mkdir $basedir; fi
    
## run stages

if $(echo $stages | grep -q ck); then
    echo '
# Compilation stage
    '
    if [ ! -e "config" ];then
        echo Downloading kernel config from github.com/quarkscript/..
        wget https://raw.githubusercontent.com/quarkscript/xe303c12_play_linux/master/config
    fi
    if [ ! -e "config" ];then
        echo Downloading kernel config from gitlab.com/quarkscript/..
        wget https://gitlab.com/quarkscript/linarm/-/raw/master/xe303c12/kali-linux/config
    fi
    if [ ! -e "config" ];then
        echo "config - kernel config file not found, probably something wrong with internet connection or repos, try pace it manually"
        exit 1
    fi
    
    if [ -d ${basedir}/kernel ]; then
	rm -fr ${basedir}/kernel
	echo remove old kernel build folder
    fi
    if [ -f ${basedir}/*.deb ]; then
        rm -f ${basedir}/*.deb
	echo remove previous builded kernel package
    fi
    if [ -d ${basedir}/kernel_pkg ]; then
        rm -fr ${basedir}/kernel_pkg
        echo remove old kernel_pkg folder
    fi
    if [ -f ${basedir}/kernel.bin ]; then
        rm -f ${basedir}/kernel.bin
        echo remove previous builded kernel.bin
    fi
    if [ -f ${basedir}/zImage ]; then
        rm -fr ${basedir}/zImage
        echo remove previous builded zImage
    fi
    if [ -d ${basedir}/linux* ]; then
        rm -fr ${basedir}/linux*
        echo remove previous linux source foldes
    fi
    
    export CROSS_COMPILE=arm-linux-gnueabihf-
    export ARCH=arm
    
    echo extract kernel source
    tar -xf ${basedir}/../linux*tar.xz -C ${basedir}/

    mv -f ${basedir}/linux* ${basedir}/kernel

    cd ${basedir}/kernel
    cp ${basedir}/../config .config

    # apply patch
    if [ ! -z "$patch" ]&&[ -f "${basedir}/../$patch" ]; then
        cp "${basedir}/../$patch" $patch
        git apply $patch
    fi

    #make menuconfig

    echo '
forcing some optimization flags
'
    for tmpcycle in $(find -name Makefile); do
        sed -i "s/armv7-a/armv7-a+mp+neon-vfpv4  --param l1-cache-size=64 --param l2-cache-size=1024 -faggressive-loop-optimizations -fguess-branch-probability -floop-nest-optimize -fomit-frame-pointer -fsel-sched-pipelining -fsel-sched-pipelining-outer-loops -fpredictive-commoning -fprefetch-loop-arrays -ftree-loop-optimize /g" $tmpcycle
        sed -i "s/vfpv /vfpv4 /g" $tmpcycle
        sed -i "s/vfpv,/vfpv4,/g" $tmpcycle
        sed -i "s/-O2/-O2 --param l1-cache-size=64 --param l2-cache-size=1024 -faggressive-loop-optimizations -fguess-branch-probability -floop-nest-optimize -fomit-frame-pointer -fsel-sched-pipelining -fsel-sched-pipelining-outer-loops -fpredictive-commoning -fprefetch-loop-arrays -ftree-loop-optimize /g" $tmpcycle
    done

    ## build
    make -j$(($(grep -c processor /proc/cpuinfo)+1)) zImage modules dtbs

    ## create deb-pkg
    mkdir ${basedir}/kernel_pkg
    mkdir ${basedir}/kernel_pkg/boot
    mkdir ${basedir}/kernel_pkg/boot/dtbs
    mkdir ${basedir}/kernel_pkg/boot/re-signing
    mkdir ${basedir}/kernel_pkg/usr
    mkdir ${basedir}/kernel_pkg/DEBIAN

    make modules_install INSTALL_MOD_PATH=${basedir}/kernel_pkg
    make headers_install INSTALL_HDR_PATH=${basedir}/kernel_pkg/usr
    cp -f arch/arm/boot/dts/exynos5250-snow.dtb ${basedir}/kernel_pkg/boot/dtbs/exynos5250-snow.dtb
    cp -f arch/arm/boot/dts/exynos5250-snow-rev5.dtb ${basedir}/kernel_pkg/boot/dtbs/exynos5250-snow-rev5.dtb
    cp -f arch/arm/boot/zImage ${basedir}/kernel_pkg/boot/zImage 
    cp -f arch/arm/boot/zImage ${basedir}/zImage 

    kernver=$(ls ${basedir}/kernel_pkg/lib/modules/ | sed 's/-XE.*//g')
    cd ${basedir}/kernel_pkg/lib/modules/$kernver
    rm -f build
    rm -f source
    ln -s /usr/src/kernel build
    ln -s /usr/src/kernel source
    
    cd ${basedir}/kernel_pkg/boot
    curl -o re-signing/kernel.keyblock https://raw.githubusercontent.com/archlinuxarm/PKGBUILDs/master/core/linux-armv7/kernel.keyblock
    curl -o re-signing/kernel_data_key.vbprivk https://raw.githubusercontent.com/archlinuxarm/PKGBUILDs/master/core/linux-armv7/kernel_data_key.vbprivk

cat << __EOF__ > re-signing/kernel-exynos.its
/dts-v1/;
 
/ {
    description = "Chrome OS kernel image with one or more FDT blobs";
    images {
        kernel@1{
            description = "kernel";
            data = /incbin/("../zImage");
            type = "kernel_noload";
            arch = "arm";
            os = "linux";
            compression = "none";
            load = <0>;
            entry = <0>;
        };
        fdt@1{
            description = "exynos5250-snow.dtb";
            data = /incbin/("../dtbs/exynos5250-snow.dtb");
            type = "flat_dt";
            arch = "arm";
            compression = "none";
            hash@1{
                algo = "sha1";
            };
        };
        fdt@2{
            description = "exynos5250-snow-rev5.dtb";
            data = /incbin/("../dtbs/exynos5250-snow-rev5.dtb");
            type = "flat_dt";
            arch = "arm";
            compression = "none";
            hash@1{
                algo = "sha1";
            };
        };
    };
    configurations {
        default = "conf@1";
        conf@1{
            kernel = "kernel@1";
            fdt = "fdt@1";
        };
        conf@2{
            kernel = "kernel@1";
            fdt = "fdt@2";
        };
    };
};

__EOF__

    echo 'console=tty0 root=PARTUUID=%U/PARTNROFF=1 zswap.compressor=zstd zswap.max_pool_percent=40 noinitrd rootwait' > re-signing/cmdline
    dd if=/dev/zero of=re-signing/bootloader.bin bs=512 count=1

    echo '#!/bin/bash
echo ""
echo re-signing kernel image
if [ -f kernel.bin ]; then 
    echo backing up existed image
    mv -f kernel.bin kernel.bin.bak; 
    echo you may restore it from kernel.bin.bak
fi
echo ""
sleep 5

mkimage -D "-I dts -O dtb -p 2048" -f re-signing/kernel-exynos.its /tmp/exynos-kernel

vbutil_kernel --arch arm --pack kernel.bin --keyblock re-signing/kernel.keyblock --signprivate re-signing/kernel_data_key.vbprivk --version 1 --config re-signing/cmdline --bootloader re-signing/bootloader.bin --vmlinuz /tmp/exynos-kernel
' > krn_re-signing
    chmod +x krn_re-signing
    ./krn_re-signing

    cp -f kernel.bin ${basedir}/kernel.bin

    echo 'Package: linux-kernel-xe303c12
Version: '"$kernver"'
Architecture: '"$architecture"'
Maintainer: Kernel build script maintainer https://git[la,hu]b.com/quarkscript
Description: Custom '"$architecture"' linux kernel, builded for XE303C12 Chromebook
Depends: '"$depends"'
Replaces: '"$replaces"'
Provides: '"$provides"'
Suggests: '"$suggests"'
'> ${basedir}/kernel_pkg/DEBIAN/control

    echo '#!/bin/bash
krnprts=""
krnprtc=0
  for i in $(ls /dev | grep -x --regexp="mmcblk[0-9]" --regexp="sd[a-z]" --regexp="vd[a-z]"); do
    if $(cgpt show /dev/$i | grep Label | grep -q [Kk]ernel); then
      if $(echo $i | grep -q mmcblk); then
        krnprts+="$i""p$(cgpt show /dev/$i | grep Label | grep [Kk]ernel -m 1 | sed '"'"'s/  / /g'"'"' | sed '"'"'s/  / /g'"'"' | sed '"'"'s/ La.*//g'"'"' | sed '"'"'s/.* //g'"'"') "
      else
        krnprts+="$i$(cgpt show /dev/$i | grep Label | grep [Kk]ernel -m 1 | sed '"'"'s/  / /g'"'"' | sed '"'"'s/  / /g'"'"' | sed '"'"'s/ La.*//g'"'"' | sed '"'"'s/.* //g'"'"') "
      fi
      krnprtc=$(($krnprtc+1))
    fi
  done
  
  echo ""
  if [ "$krnprtc" -eq 0 ]; then
    echo "Chrome OS kernel partition did not detected." 
    echo "You must reflash kernel manually."
  elif [ "$krnprtc" -eq 1 ]; then
    echo "Finded ChromeOs kernel partition - $krnprts"
    echo "Do you want to flash a new kernel to it? (y/n)"
    read -r shouldwe
    if [[ $shouldwe =~ ^([yY][eE][sS]|[yY])$ ]]; then
      dd if=/boot/kernel.bin of=/dev/$krnprts
      sync
    else
      echo "You may flash kernel manually like:"
      echo "dd if=/boot/kernel.bin of=/dev/$krnprts"
    fi
  else
    echo "Finded more than one Chrome OS kernel partition."
    echo "You need to select next action
    "
    echo "0 for do not flash"
    numpart=0
    for i in $krnprts; do
      numpart=$(($numpart+1))
      echo "$numpart for flash $i partition"
    done
    echo ""
    echo "Wrong partition may lead to bootfail. Be aware!"
    read -r shouldwe
    if [ $shouldwe -gt 0 ]&&[ $shouldwe -le $numpart ]; then
      numpart=0
      for i in $krnprts; do
        numpart=$(($numpart+1))
        if [ $numpart -eq $shouldwe ]; then
          dd if=/boot/kernel.bin of=/dev/$i
          sync
        fi
      done
    fi
  fi
'> ${basedir}/kernel_pkg/DEBIAN/postinst
    chmod 0755 ${basedir}/kernel_pkg/DEBIAN/postinst
    cd ${basedir}/
    dpkg-deb --build ${basedir}/kernel_pkg $(echo linux-kernel-xe303c12-$kernver).deb

    #cd ${basedir}/kernel/
    #make mrproper
    #cp ${basedir}/../config_w .config
    #rm -f ${basedir}/../config_w
    #make modules_prepare
fi    
if $(echo $stages | grep -q bts); then
        echo '
# Build target system stage
    '
    
    cd ${basedir}
    if [ -d $target_hostname-$architecture ];then
	echo remove previous build
        umount ${basedir}/$target_hostname-$architecture/proc/sys/fs/binfmt_misc
        umount ${basedir}/$target_hostname-$architecture/proc
        umount ${basedir}/$target_hostname-$architecture/dev/pts
        umount ${basedir}/$target_hostname-$architecture/dev
	rm -fr $target_hostname-$architecture
	if [ -f debootstrap.log ]; then rm -f debootstrap.log; fi
    fi
    $debootstrap_string |& tee debootstrap.log
    if $(cat debootstrap.log | grep -q "Couldn't download package" -m 1); then
        echo ''
        echo 'Restart debootstrap'
        echo ''
        $debootstrap_string |& tee debootstrap.log
    fi
    if $(cat debootstrap.log | grep -q "Couldn't download package" -m 1); then
        echo ''
        echo 'Restart debootstrap'
        echo ''
        $debootstrap_string |& tee debootstrap.log
    fi
    if $(cat debootstrap.log | grep -q "Couldn't download package" -m 1); then
        echo "seems some problems with network or repos; try to run $0 later"
        exit 1
    fi
    cp /usr/bin/qemu-arm-static $target_hostname-$architecture/usr/bin/
    LANG=C chroot $target_hostname-$architecture /debootstrap/debootstrap --second-stage
    # Create sources.list
cat << EOF > $target_hostname-$architecture/etc/apt/sources.list
$sources_list
EOF
    echo "$target_hostname" > $target_hostname-$architecture/etc/hostname
cat << EOF > $target_hostname-$architecture/etc/hosts
127.0.0.1       $target_hostname    localhost
::1             localhost ip6-localhost ip6-loopback
fe00::0         ip6-localnet
ff00::0         ip6-mcastprefix
ff02::1         ip6-allnodes
ff02::2         ip6-allrouters
EOF
cat << EOF > $target_hostname-$architecture/etc/network/interfaces
auto lo
iface lo inet loopback
EOF
cat << EOF > $target_hostname-$architecture/etc/resolv.conf
nameserver 1.1.1.1
EOF
    export MALLOC_CHECK_=0 # workaround for LP: #520465
    export LC_ALL=C
    export DEBIAN_FRONTEND=noninteractive
    mount -t proc proc $target_hostname-$architecture/proc
    mount -o bind /dev/ $target_hostname-$architecture/dev/
    mount -o bind /dev/pts $target_hostname-$architecture/dev/pts
cat << EOF > $target_hostname-$architecture/debconf.set
console-common console-data/keymap/policy select Select keymap from full list
console-common console-data/keymap/full select en-latin1-nodeadkeys
EOF
	tmpvar1='$(grep -xq $i /tmp/aptlist)'
	paclist='$paclist'
	i='$i'
	
	check_mkl='$(cat aptgetmainpkg.log | grep -q --regexp="Cannot initiate the connection" --regexp="Unable to connect" -m 1)'
cat << EOF > $target_hostname-$architecture/third-stage
#!/bin/bash
dpkg-divert --add --local --divert /usr/sbin/invoke-rc.d.chroot --rename /usr/sbin/invoke-rc.d
cp /bin/true /usr/sbin/invoke-rc.d
echo -e "#!/bin/sh\nexit 101" > /usr/sbin/policy-rc.d
chmod +x /usr/sbin/policy-rc.d

apt-get update
apt-get --yes --force-yes install locales-all

debconf-set-selections /debconf.set
rm -f /debconf.set
apt-get update

apt-get -y -d install $targetpackages_2 |& tee aptgetmainpkg.log
if $check_mkl; then
   apt-get -y -d install $targetpackages_2 |& tee aptgetmainpkg.log
   sleep 5
fi
if $check_mkl; then
   apt-get -y -d install $targetpackages_2 |& tee aptgetmainpkg.log
fi
apt-get -y install $targetpackages_2

apt-get -y -d install $targetpackages_3 
if $check_mkl; then
   apt-get -y -d install $targetpackages_3 |& tee aptgetmainpkg.log
   sleep 5
fi
if $check_mkl; then
   apt-get -y -d install $targetpackages_3 |& tee aptgetmainpkg.log
fi
apt-get -y install $targetpackages_3

echo "root:toor" | chpasswd
sed -i -e 's/KERNEL\!=\"eth\*|/KERNEL\!=\"/' /lib/udev/rules.d/75-persistent-net-generator.rules
rm -f /etc/udev/rules.d/70-persistent-net.rules
export DEBIAN_FRONTEND=noninteractive

## check and remove from install list unavailable packages
paclist=""
LANG=C apt list | sed 's/\/.*//g' >/tmp/aptlist
for i in $targetpackages; do
	if $tmpvar1; then 
		paclist+="$i "
	else 
		echo $i " is unavailable, it will be ignored during install"
	fi
done

rm -f /tmp/aptlist

apt-get --yes --force-yes -d install $paclist $nir |& tee aptgetmainpkg.log
sleep 5
if $check_mkl; then
   apt-get --yes --force-yes -d install $paclist $nir |& tee aptgetmainpkg.log
fi
sleep 5
if $check_mkl; then
   apt-get --yes --force-yes -d install $paclist $nir |& tee aptgetmainpkg.log
fi
sleep 5
if $check_mkl; then
   apt-get --yes --force-yes -d install $paclist $nir |& tee aptgetmainpkg.log
fi
sleep 5
if $check_mkl; then
   apt-get --yes --force-yes -d install $paclist $nir |& tee aptgetmainpkg.log
fi
if $check_mkl; then
   echo ''
   echo 'Something wrong with network or repos. Some packages will be missed.'
   echo ''
fi
apt-get --yes --force-yes install $paclist $nir 
apt-get --yes --force-yes dist-upgrade $nir 
apt-get --yes --force-yes autoremove
apt-get clean

rm -f /usr/sbin/policy-rc.d
rm -f /usr/sbin/invoke-rc.d
dpkg-divert --remove --rename /usr/sbin/invoke-rc.d

rm -f /third-stage


# download firmwares
if [ ! -d $firmware_dir ]; then
    mkdir -p $firmware_dir
fi
# samsung
if [ ! -f $firmware_dir/s5p-mfc.fw ]; then
    curl -o $firmware_dir/s5p-mfc.fw https://git.kernel.org/pub/scm/linux/kernel/git/firmware/linux-firmware.git/plain/s5p-mfc.fw
fi
if [ ! -f $firmware_dir/s5p-mfc-v6-v2.fw ]; then
    curl -o $firmware_dir/s5p-mfc-v6-v2.fw https://git.kernel.org/pub/scm/linux/kernel/git/firmware/linux-firmware.git/plain/s5p-mfc-v6-v2.fw
fi
if [ ! -f $firmware_dir/s5p-mfc-v6.fw ]; then
    curl -o $firmware_dir/s5p-mfc-v6.fw https://git.kernel.org/pub/scm/linux/kernel/git/firmware/linux-firmware.git/plain/s5p-mfc-v6.fw
fi
if [ ! -f $firmware_dir/s5p-mfc-v7.fw ]; then
    curl -o $firmware_dir/s5p-mfc-v7.fw https://git.kernel.org/pub/scm/linux/kernel/git/firmware/linux-firmware.git/plain/s5p-mfc-v7.fw
fi
if [ ! -f $firmware_dir/s5p-mfc-v8.fw ]; then
    curl -o $firmware_dir/s5p-mfc-v8.fw https://git.kernel.org/pub/scm/linux/kernel/git/firmware/linux-firmware.git/plain/s5p-mfc-v8.fw
fi
if [ ! -d $firmware_dir/mrvl ]; then
    mkdir -p $firmware_dir/mrvl
fi
# marvel
if [ ! -f $firmware_dir/mrvl/sd8787_uapsta.bin ]; then
    curl -o $firmware_dir/mrvl/sd8787_uapsta.bin https://git.kernel.org/pub/scm/linux/kernel/git/firmware/linux-firmware.git/plain/mrvl/sd8787_uapsta.bin
fi
if [ ! -f $firmware_dir/mrvl/sd8797_uapsta.bin ]; then
    curl -o $firmware_dir/mrvl/sd8797_uapsta.bin https://git.kernel.org/pub/scm/linux/kernel/git/firmware/linux-firmware.git/plain/mrvl/sd8797_uapsta.bin
fi
if [ ! -f $firmware_dir/mrvl/sd8897_uapsta.bin ]; then
    curl -o $firmware_dir/mrvl/sd8897_uapsta.bin https://git.kernel.org/pub/scm/linux/kernel/git/firmware/linux-firmware.git/plain/mrvl/sd8897_uapsta.bin
fi
sleep 5

EOF
    chmod +x $target_hostname-$architecture/third-stage
    LANG=C chroot $target_hostname-$architecture /third-stage
    umount ${basedir}/$target_hostname-$architecture/proc/sys/fs/binfmt_misc
    umount ${basedir}/$target_hostname-$architecture/proc
    umount ${basedir}/$target_hostname-$architecture/dev/pts
    umount ${basedir}/$target_hostname-$architecture/dev
fi 

if $(echo $stages | grep -q bdi); then
    echo '
# Build disk image stage
    '
    rootsize=$(du -s -BM ${basedir}/$target_hostname-$architecture/ 2>&1 | tail -n1 | sed 's/M.*//g')
    if [ "$rootsize" -gt "$(($disksize*9/10))" ]&&[ "$fstype" == "ext4" ];then
	echo Disk image size is too small. Try to repeat bdi stage with bigger disk size
	exit 1
    elif [ $rootsize -gt $(($disksize*2*9/10)) ]&&[ $fstype != ext4 ];then
	echo Disk image size is too small even filesystem compression may not help. Try to repeat bdi stage with bigger disk size
	exit 1
    fi

    cd ${basedir}/
    if [ -d "${basedir}/root" ]; then
        umount ${basedir}/root
        rm -fr ${basedir}/root
    fi
    umount /dev/mapper/loop*
    if [ -f "${basedir}/$target_hostname-$architecture-xe303c12.img" ]; then
        rm -f ${basedir}/$target_hostname-$architecture-xe303c12.img
    fi
    
    echo "Creating image file for Exynos-based Samsung XE303C12 Chromebook"
    
    dd if=/dev/zero of=${basedir}/$target_hostname-$architecture-xe303c12.img bs=1M count=$disksize
    
    parted $target_hostname-$architecture-xe303c12.img --script -- mklabel gpt
    
    cgpt create -z $target_hostname-$architecture-xe303c12.img
    
    cgpt create $target_hostname-$architecture-xe303c12.img
    
    cgpt add -i 1 -t kernel -b 8192 -s 32768 -l kernel -S 1 -T 5 -P 10 $target_hostname-$architecture-xe303c12.img
    
    cgpt add -i 2 -t data -b 40960 -s `expr $(cgpt show $target_hostname-$architecture-xe303c12.img | grep 'Sec GPT table' | awk '{ print \$1 }')  - 40960` -l Root $target_hostname-$architecture-xe303c12.img
    
    loopdevice=`losetup -f --show ${basedir}/$target_hostname-$architecture-xe303c12.img`
    
    device=`kpartx -va $loopdevice| sed -E 's/.*(loop[0-9])p.*/\1/g' | head -1`
    
    sleep 5
    
    device="/dev/mapper/${device}"
    bootp=${device}p1
    rootp=${device}p2

    mkdir -p ${basedir}/root
    if [ "$fstype" == "btrfs" ]; then
        mkfs.btrfs -f --label rootfs $rootp
        mount $rootp ${basedir}/root -o,compress,noatime,ssd
    elif [ "$fstype" == "f2fs" ]; then
        mkfs.f2fs -f -O 'extra_attr flexible_inline_xattr compression encrypt ' -l rootfs $rootp
        mount $rootp ${basedir}/root -o,compress_algorithm=lzo,compress_extension=*
    else
        mkfs.ext4 -O ^flex_bg -O ^metadata_csum -L rootfs $rootp
        mount $rootp ${basedir}/root
    fi

    rootuuid=$(LANG=C blkid | grep "$rootp" | grep 'LABEL="rootfs"' | sed 's/.* UUID="//g' | sed 's/".*//g')
    
    echo "Rsyncing rootfs into image file"
    rsync -HPavz -q ${basedir}/$target_hostname-$architecture/ ${basedir}/root/
    if [ $? -ne 0 ]; then 
        echo '
    Looks like not enough space at disk image. 
    Disk image build process terminated.
        '
        umount $rootp
        exit 1
    fi
    
    echo '
Install kernel and clear disk image from debootstrap
    '
    export MALLOC_CHECK_=0 # workaround for LP: #520465
    export LC_ALL=C
    export DEBIAN_FRONTEND=noninteractive
    mount -t proc proc ${basedir}/root/proc
    mount -o bind /dev/ ${basedir}/root/dev
    mount -o bind /dev/pts ${basedir}/root/dev/pts
    
    krn_pkg_name=$(ls ${basedir}/ | grep .deb)
    if [ ! -z "$krn_pkg_name" ]; then
        cp ${basedir}/$krn_pkg_name ${basedir}/root/$krn_pkg_name
cat << EOF >${basedir}/root/install-kernel
apt-get install /$krn_pkg_name --force-yes --yes
EOF
        chmod +x ${basedir}/root/install-kernel
        LANG=C chroot ${basedir}/root /install-kernel
    else
	echo '
No kernel package was found. Linux disk image will be unfunctional.
'
    fi
    
cat << EOF > ${basedir}/root/cleanup
#!/bin/bash
rm -rf /root/.bash_history
apt-get update $nir 
apt-get clean
rm -f /0
rm -f /hs_err*
rm -f cleanup
rm -f /usr/bin/qemu*
rm -f install-kernel
EOF
    chmod +x ${basedir}/root/cleanup
    LANG=C chroot ${basedir}/root /cleanup
    umount ${basedir}/root/proc/sys/fs/binfmt_misc
    umount ${basedir}/root/proc
    umount ${basedir}/root/dev/pts
    umount ${basedir}/root/dev
    
    
cat << EOF > ${basedir}/root/etc/apt/sources.list
$sourcelist
EOF
    if [ "$fstype" == "btrfs" ]; then
cat << EOF> ${basedir}/root/etc/fstab
# /etc/fstab: static file system information.
#
# Use 'blkid' to print the universally unique identifier for a
# device; this may be used with UUID= as a more robust way to name devices
# that works even if disks are added and removed. See fstab(5).
#
# <file system> <mount point>   <type>  <options>       <dump>  <pass>
# / was on /dev/sda2 during installation
UUID=$rootuuid /               btrfs    rw,noatime,compress=zstd:5,autodefrag,ssd 0       0
# swap was on /dev/sdaX during installation
#UUID= none            swap    sw              0       0
#/dev/sr0        /media/cdrom0   udf,iso9660 user,noauto     0       0
EOF
    elif [ "$fstype" == "f2fs" ]; then
cat << EOF> ${basedir}/root/etc/fstab
# /etc/fstab: static file system information.
#
# Use 'blkid' to print the universally unique identifier for a
# device; this may be used with UUID= as a more robust way to name devices
# that works even if disks are added and removed. See fstab(5).
#
# <file system> <mount point>   <type>  <options>       <dump>  <pass>
# / was on /dev/sda2 during installation
UUID=$rootuuid /               f2fs    rw,noatime,compress_algorithm=zstd,compress_extension=* 0       1
# swap was on /dev/sdaX during installation
#UUID= none            swap    sw              0       0
#/dev/sr0        /media/cdrom0   udf,iso9660 user,noauto     0       0
EOF
    else
cat << EOF> ${basedir}/root/etc/fstab
# /etc/fstab: static file system information.
#
# Use 'blkid' to print the universally unique identifier for a
# device; this may be used with UUID= as a more robust way to name devices
# that works even if disks are added and removed. See fstab(5).
#
# <file system> <mount point>   <type>  <options>       <dump>  <pass>
# / was on /dev/sda2 during installation
UUID=$rootuuid /               ext4    rw,noatime 0       1
# swap was on /dev/sdaX during installation
#UUID= none            swap    sw              0       0
#/dev/sr0        /media/cdrom0   udf,iso9660 user,noauto     0       0
EOF
    fi
    
    cd ${basedir}
    # Bit of a hack to hide eMMC partitions from XFCE
#cat << EOF > ${basedir}/root/etc/udev/rules.d/99-hide-emmc-partitions.rules
#KERNEL=="mmcblk0*", ENV{UDISKS_IGNORE}="1"
#EOF
    # Disable uap0 and p2p0 interfaces in NetworkManager
    #printf '\n[keyfile]\nunmanaged-devices=interface-name:p2p0\n' >> ${basedir}/root/etc/NetworkManager/NetworkManager.conf
    
    # Touchpad configuration
    mkdir -p ${basedir}/root/etc/X11/xorg.conf.d
cat << EOF > ${basedir}/root/etc/X11/xorg.conf.d/10-synaptics-chromebook.conf
Section "InputClass"
	Identifier		"touchpad"
	MatchIsTouchpad		"on"
	Driver			"synaptics"
	Option			"TapButton1"	"1"
	Option			"TapButton2"	"3"
	Option			"TapButton3"	"2"
	Option			"FingerLow"		"15"
	Option			"FingerHigh"	"20"
	Option			"FingerPress"	"256"
EndSection
EOF
	# Mali GPU rules aka mali-rules package in ChromeOS
cat << EOF > ${basedir}/root/etc/udev/rules.d/50-mali.rules
KERNEL=="mali0", MODE="0660", GROUP="video"
EOF
	# Video rules aka media-rules package in ChromeOS
cat << EOF > ${basedir}/root/etc/udev/rules.d/50-media.rules
ATTR{name}=="s5p-mfc-dec", SYMLINK+="video-dec"
ATTR{name}=="s5p-mfc-enc", SYMLINK+="video-enc"
ATTR{name}=="s5p-jpeg-dec", SYMLINK+="jpeg-dec"
ATTR{name}=="exynos-gsc.0*", SYMLINK+="image-proc0"
ATTR{name}=="exynos-gsc.1*", SYMLINK+="image-proc1"
ATTR{name}=="exynos-gsc.2*", SYMLINK+="image-proc2"
ATTR{name}=="exynos-gsc.3*", SYMLINK+="image-proc3"
EOF

    if [ -f "${basedir}/root/etc/ssh/sshd_config" ]; then
        sed -i -e 's/^#PermitRootLogin.*/PermitRootLogin yes/' ${basedir}/root/etc/ssh/sshd_config
    fi
    
    # Unmount partitions
    umount $rootp
    if [ -f "${basedir}/kernel.bin" ]; then
        dd if=${basedir}/kernel.bin of=$bootp
    else
	echo '
Kernel flash image not found. Linux disk image may be unbootable
'
    fi
    
    kpartx -dv $loopdevice
    losetup -d $loopdevice

    echo "
Script execution ends, if all complete without errors you can write result image with dd, 
for example:
dd if=${basedir}/$target_hostname-$architecture-xe303c12.img \
of=/dev/'flash stick' bs=8M status=progress

Be aware! Wrong /dev/'flash stick' can permanently destroy data on hard drives!
"

fi
    
